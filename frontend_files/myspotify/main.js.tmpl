/* My Spotify Homepage — Owner's Public Data (no auth required) */
(function () {
  "use strict";

  /* ── Admin Auth UI ── */
  var adminLoginBtn = document.getElementById("admin-login-btn");
  var adminStatus = document.getElementById("admin-status");

  // Check if admin is already authenticated
  fetch("/api/auth/status", { credentials: "include" })
    .then(function (res) { return res.json(); })
    .then(function (data) {
      if (data.logged_in && data.is_owner) {
        // Admin is authenticated
        if (adminLoginBtn) adminLoginBtn.style.display = "none";
        if (adminStatus) {
          adminStatus.style.display = "";
          adminStatus.innerHTML = '<span class="admin-status-connected">&#10004; Admin Connected</span>';
        }
      } else {
        // Not authenticated or not owner
        if (adminLoginBtn) adminLoginBtn.style.display = "";
        if (adminStatus) adminStatus.style.display = "none";
      }
    })
    .catch(function () {
      // Error checking status — show login button
      if (adminLoginBtn) adminLoginBtn.style.display = "";
      if (adminStatus) adminStatus.style.display = "none";
    });

  // Admin login button click
  if (adminLoginBtn) {
    adminLoginBtn.addEventListener("click", function () {
      window.location.href = "/api/auth/login";
    });
  }

  /* ── Collage ── */
  var DATA_URLS = ["/data/spotify_data.json", "/api/owner/top-artists", "/api/owner/top-albums"];
  var collageGrid = document.getElementById("collage-grid");

  function extractImages(data) {
    var images = [];
    if (data.albums) {
      data.albums.forEach(function (a) { if (a.image) images.push(a.image); });
    }
    if (data.artists) {
      data.artists.forEach(function (a) { if (a.image) images.push(a.image); });
    }
    if (data.tracks) {
      data.tracks.forEach(function (t) { if (t.image) images.push(t.image); });
    }
    return images;
  }

  function renderCollage(images) {
    if (!collageGrid) return;
    var unique = [];
    var seen = {};
    images.forEach(function (img) {
      if (!seen[img]) {
        seen[img] = true;
        unique.push(img);
      }
    });
    var selected = unique.slice(0, 24);
    collageGrid.innerHTML = "";
    selected.forEach(function (src) {
      var img = document.createElement("img");
      img.src = src;
      img.alt = "Album cover";
      img.loading = "lazy";
      collageGrid.appendChild(img);
    });
  }

  function loadCollage() {
    var allImages = [];
    var completed = 0;

    DATA_URLS.forEach(function (url) {
      var opts = {};
      if (url.indexOf("/api/") === 0) opts.credentials = "include";
      fetch(url, opts)
        .then(function (res) {
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.json();
        })
        .then(function (data) {
          allImages = allImages.concat(extractImages(data));
        })
        .catch(function () { /* Silently skip unavailable data files */ })
        .finally(function () {
          completed++;
          if (completed === DATA_URLS.length) {
            renderCollage(allImages);
          }
        });
    });
  }

  loadCollage();
})();
